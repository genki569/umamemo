{% extends "base.html" %}

{% block content %}
<div class="races-header">
    <div class="container">
        <div class="header-content">
            <h1>レース一覧</h1>
            <p class="header-description">
                JRAの開催レース情報を日付別に確認できます。
                各レースの詳細情報や出走馬を閲覧できます。
            </p>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="race-list-container">
        <!-- 日付選択部 -->
        <div class="date-selector">
            <div class="date-navigation">
                <button class="date-nav-btn" onclick="navigateDate('prev')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="date-buttons">
                    {% for date in dates %}
                    <a href="{{ url_for('races', date=date.value) }}" 
                       class="date-btn {% if date.value == selected_date %}active{% endif %}">
                        {{ date.month }}/{{ date.day }}<br>
                        ({{ date.weekday }})
                    </a>
                    {% endfor %}
                </div>
                <button class="date-nav-btn" onclick="navigateDate('next')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <!-- 日付選択ドロップダウンを追加 -->
            <div class="date-selector-container">
                <select id="date-selector" onchange="changeDate(this.value)">
                    {% for date in dates %}
                        <option value="{{ date.value }}"
                                {% if date.value == selected_date %}selected{% endif %}>
                            {{ date.month }}/{{ date.day }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- 会場ごとのセクション -->
        {% if races_by_venue %}
            {% for venue, races in races_by_venue.items() %}
                <div class="venue-section">
                    <h3 class="venue-name">{{ venue }}</h3>
                    <div class="race-cards">
                        {% for race in races %}
                            <div class="race-card">
                                <div class="race-header">
                                    <span class="race-number">{{ race.race_number }}R</span>
                                    <span class="race-time">{{ race.post_time.strftime('%H:%M') }}</span>
                                </div>
                                <h4 class="race-name">
                                    <a href="{{ url_for('race_detail', race_id=race.id) }}">{{ race.name }}</a>
                                </h4>
                                <div class="race-info">
                                    <span class="race-course">{{ race.course_type }} {{ race.distance }}m</span>
                                    <span class="race-class">{{ race.race_class }}</span>
                                </div>
                                <div class="race-actions">
                                    <a href="{{ url_for('race_detail', race_id=race.id) }}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-info-circle"></i> 詳細
                                    </a>
                                    {% if current_user.is_authenticated %}
                                        <a href="{{ url_for('race_detail', race_id=race.id) }}#prediction" class="btn btn-success btn-sm">
                                            <i class="fas fa-chart-line"></i> 予想
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="no-races-message">
                <p>選択された日付のレース情報はありません。</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const scrollContainer = document.querySelector('.date-buttons');
    
    // アクティブな日付を中央に表示
    const activeButton = document.querySelector('.date-btn.active');
    if (activeButton) {
        setTimeout(() => {
            activeButton.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest',
                inline: 'center'
            });
        }, 100);
    }
});

function navigateDate(direction) {
    const buttons = Array.from(document.querySelectorAll('.date-btn'));
    const activeButton = document.querySelector('.date-btn.active');
    const currentIndex = buttons.indexOf(activeButton);
    
    let newIndex;
    if (direction === 'next') {
        newIndex = currentIndex + 1;  // より過去の日付へ（右へ）
    } else if (direction === 'prev') {
        newIndex = currentIndex - 1;  // より新しい日付へ（左へ）
    }
    
    if (newIndex !== undefined && buttons[newIndex]) {
        window.location.href = buttons[newIndex].href;
    }
}

// 左右キー操作のサポート
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        navigateDate('prev');
    } else if (e.key === 'ArrowRight') {
        navigateDate('next');
    }
});

function changeDate(date) {
    window.location.href = '/races?date=' + date;
}
</script>

<style>
.date-selector-container {
    margin: 20px 0;
    text-align: center;
}

#date-selector {
    padding: 5px 10px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: white;
    min-width: 100px;
}

/* 横スクロールを防止するスタイル */
.container {
    max-width: 100%;
    padding-left: 15px;
    padding-right: 15px;
    overflow-x: hidden;
}

/* レースカードのレスポンシブ対応 */
.race-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

@media (max-width: 768px) {
    .race-cards {
        grid-template-columns: 1fr;
    }
    
    .date-buttons {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
        padding-bottom: 5px;
    }
    
    .date-buttons::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Edge */
    }
}
</style>
{% endblock %}