{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="mb-3">
        <a href="{{ url_for('race_detail', race_id=race.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> レース結果に戻る
        </a>
    </div>

    <h2>{{ race.name }} - レース回顧</h2>
    <div class="race-info mb-3">
        <span class="text-muted">{{ race.date }} {{ race.venue }}</span>
    </div>

    <form method="POST" action="{{ url_for('save_review', race_id=race.id) }}" class="review-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div class="form-group mb-3">
            <label for="summary">要約（100文字以内）</label>
            <input type="text" class="form-control" id="summary" name="summary" 
                   maxlength="100" value="{{ review.summary if review else '' }}">
        </div>
        
        <div class="form-group mb-3">
            <label for="content">レース分析</label>
            <textarea class="form-control" id="content" name="content" rows="10" required>{{ review.content if review else '' }}</textarea>
        </div>
        
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="is_premium" name="is_premium"
                   {% if review and review.is_premium %}checked{% endif %}>
            <label class="form-check-label" for="is_premium">
                有料コンテンツとして公開する
            </label>
        </div>
        
        <div class="form-group mb-3 premium-price" style="{% if not review or not review.is_premium %}display: none;{% endif %}">
            <label for="price">価格（ポイント）</label>
            <input type="number" class="form-control" id="price" name="price" min="1" max="1000"
                   value="{{ review.price if review and review.price else 100 }}">
        </div>
        
        <button type="submit" class="btn btn-primary">保存する</button>
    </form>
</div>

<style>
.review-form textarea {
    font-size: 0.95rem;
    line-height: 1.5;
}

.review-form textarea:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.review-form .card {
    border: 1px solid rgba(0,0,0,.125);
}

.review-form .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,.125);
}

.review-form .form-check-label {
    color: #495057;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const saleStatus = document.getElementById('saleStatus');
    const priceSection = document.getElementById('priceSection');
    const priceInput = document.querySelector('input[name="price"]');

    // 初期表示の設定
    if (saleStatus.value === 'paid') {
        priceSection.style.display = 'block';
        priceInput.required = true;
    }

    // 選択変更時の処理
    saleStatus.addEventListener('change', function() {
        if (this.value === 'paid') {
            priceSection.style.display = 'block';
            priceInput.required = true;
            if (!priceInput.value) {
                priceInput.value = '100';  // デフォルト値
            }
        } else {
            priceSection.style.display = 'none';
            priceInput.required = false;
        }
    });

    // フォーム送信前の検証
    document.querySelector('form').addEventListener('submit', function(e) {
        if (saleStatus.value === 'paid' && (!priceInput.value || priceInput.value < 100)) {
            e.preventDefault();
            alert('有料販売の場合は、100ポイント以上の価格を設定してください。');
        }
    });
});
</script>
{% endblock %} 